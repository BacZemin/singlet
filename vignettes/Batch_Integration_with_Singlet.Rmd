---
title: "Batch Integration with Singlet"
author: "Zach DeBruine"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Batch Integration with Singlet}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

Use the Seurat `ifnb` dataset:

```{R, warning = FALSE, message = FALSE}
library(Seurat)
library(ggplot2)
library(singlet)
library(SeuratData)
data(ifnb)
ifnb <- NormalizeData(ifnb, verbose = FALSE)
```

First we determine number of factors using cross-validation.  This can be intensive so we start with a course-grained search to get an idea, and then zero-in with a few replicates.

Note the use of `split.by = "stim"`, where we are indicating that the "stim" field in the `meta.data` slot of our Seurat object is a factor giving discrete groupings of samples (either stimulated or unstimulated).  The `RunNMF` function will weight samples from both groups equally in the NMF objective, regardless of whether the groups are of equal size.

```{R, eval = FALSE}
set.seed(123)
ifnb <- RunNMF(ifnb, split.by = "stim", k = seq(5, 40, 5), n_replicates = 1, verbose = 1)
RankPlot(ifnb)
```

```{R, eval = FALSE}
set.seed(123)
ifnb <- RunNMF(ifnb, split.by = "stim", k = 25:35, n_replicates = 3, verbose = 1)
RankPlot(ifnb)
```

Now learn a really good model at the optimal rank:

```{R, message = FALSE, warning = FALSE}
set.seed(123)
ifnb <- RunNMF(ifnb, k = 24, tol = 1e-5)
```

Visualize contribution of groups to both factors:

```{R}
MetadataPlot(ifnb, split.by = "stim", reduction = "nmf")
```

Some factors are almost exclusively explaining signal from one dataset, and not the other.

Linked NMF will uncouple sample groups from factors in which they are only weakly represented. LNMF is initialized with the joint NMF model that we trained before, we just specify a cutoff for the minimum fractional representation of any sample group in any given factor at which it will be uncoupled from the factor.

```{R}
ifnb <- RunLNMF(ifnb, split.by = "stim", reduction.use = "nmf", link.cutoff = 0.5, tol = 1e-5, link.balance.rate = 0)
```

LNMF creates a new reduction in the Seurat object, `lnmf`. Now examine how each group is represented in NMF factors:

```{R}
MetadataPlot(ifnb, split.by = "stim", reduction = "lnmf")
```

We can visualize these models on UMAP coordinates using the joint model, the entire linked NMF model, and the linked NMF model using only shared factors:

```{R}
ifnb <- RunUMAP(ifnb, reduction = "nmf", dims = 1:ncol(ifnb@reductions$nmf), reduction.name = "jnmf_all")
ifnb <- RunUMAP(ifnb, reduction = "lnmf", dims = 1:ncol(ifnb@reductions$lnmf), reduction.name = "lnmf_all")
ifnb <- RunUMAP(ifnb, reduction = "lnmf", dims = GetSharedFactors(ifnb, split.by = "stim"), reduction.name = "lnmf_shared")
selected_factors <-  which(rowSums(ifnb@reductions$lnmf@misc$link_matrix == 0) == 0)
ifnb <- RunUMAP(ifnb, reduction = "nmf", dims = selected_factors, reduction.name = "jnmf_shared")
p_jnmf_umap <- DimPlot(ifnb, reduction = "jnmf_all", group.by = "stim")
p_jnmf_shared_umap <- DimPlot(ifnb, reduction = "jnmf_shared", group.by = "stim")
p_lnmf_all_umap <- DimPlot(ifnb, reduction = "lnmf_all", group.by = "stim")
p_lnmf_shared_umap <- DimPlot(ifnb, reduction = "lnmf_shared", group.by = "stim")
plot_grid(plot_grid(
  p_jnmf_umap + ggtitle("joint NMF") + theme(legend.position = "none") + theme(legend.position = "none"), 
  p_jnmf_shared_umap + ggtitle("joint NMF, selected factors") + theme(legend.position = "none"), 
  p_lnmf_all_umap + ggtitle("linked NMF, all factors") + theme(legend.position = "none"), 
  p_lnmf_shared_umap + ggtitle("linked NMF, shared factors") + theme(legend.position = "none"), 
  nrow = 2, ncol = 2
 ), get_legend(p_jnmf_umap), ncol = 2, rel_widths = c(1, 0.2))
```
